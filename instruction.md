# Инструкция
Инструкция была написана осень 2015 года, предположительно в ноябре. ПОсле были некоторые зименения и дополнения. Выкладываю вариант без изменений (за исключением разметки) на момент 17/04/2016


## Описание программы
Система динамического распределения аккаунтов Steam предназначена, как ни странно, для выдачи аккаунтов клиентском компьютерам по запросу. По техническому заданию предполагается, что есть единая база данных, где хранятся все аккаунты, и по запросу клиента серверная программа берет данные и отправляет на игровой компьютер. Клиентская программа принимает данные и запускает Steam и конкретную его игру. В процессе работы Steam клиент отслеживает его, и если Steam завершается, то клиентская программа отправляет уведомление о том, что данный аккаунт более не используется. Серверная программа принимает запрос и изменяет статус данного аккаунта с «занят» на «свободен».

Система раздачи Steam-аккаунтов состоит из 3 элементов:
1. Сервер базы данных (далее БАЗА). Представляет собой базу данных PostgreSQL на удаленной серверной машине.
2. Серверное приложение (далее СЕРВЕР). Отвечает за прием и удовлетворение запросов от клиентских приложений. Выдает аккаунт либо ответ о том, что запрос сейчас не может быть выполнен.
3. Клиентское приложение (далее КЛИЕНТ). По запуску запрашивает данные аккаунта и отображает ответ от сервера.

**Цель** разработанной системы – определить, какое количество аккаунтов в действительности используются, чтобы в дальнейшем сократить их число. 
Установка программ как таковая не требуется – необходимо лишь создать директорию на диске компьютера и копировать в нее все необходимые файлы.
 
# Техническое задание
На обсуждении структуры до разработки системы было составлено техническое задание. Текст технического задания был дополнен описанием всех функций, которые реализованы на данный момент. Текст задания и описание его пунктов:

| ПУНКТ |	ОПИСАНИЕ| 
| ------ | ---------| 
| СЕРВЕР | Разработка серверного приложения для обработки данных. Исключает редактирование базы данных. Программа берет из файла настроек данные для подключения к базе данных: логин, пароль, имя базы данных и адрес подключения. Порт используется стандартный для PostgreSQL – 5432. Стоит учитывать, что порт подключения должен быть открытым и доступным для подключения.| 
| ИНТЕРФЕЙС | Представление базы данных – позволяет полностью отслеживать базу данных и процесс ее работы. Интерфейс представляет собой программу, которая отображает таблицы аккаунтов и статистики, а также имеет инструменты для редактирования таблиц аккаунтов и лимитов клубов. Для ведения статистического учета программа позволяет отобразить использованные аккаунты за определенные интервалы времени и вывести результат в Excell.| 
| БАЗА | База данных PostgreSQL располагается на удаленном сервере. В составе базы данных располагаются три таблицы: аккаунтов, лимитов и статистики.| 
| КЛИЕНТ | Клиентское приложение – запускает Steam, запрашивает аккаунт, передает аккаунт в Steam, запускает игру.
КЭШ АККАУНТОВ |	Создание кэша аккаунтов, хранимого на локальном сервере. На данный момент не реализован, так как не было определено алгоритма его работы.| 
| СТАТИСТИКА | Ведение статистики – с помощью отдельной базы данных отслеживание статистики аккаунтов по времени. Проверка за последний час, день, иные операции.| 
| ИНТЕРАКТИВ | Интерактив с игроком-пользователем. Разработка файла конфигурации, где можно было бы записывать сообщение для игрока, показываемое в окне клиента. Файл конфигурации реализован.| 
| ОБНОВЛЕНИЕ | Создание модуля обновления для того, чтобы в случае масштабного обновления программы была возможность автоматически заменить старый файл программы на новый. На данный момент реализована функция проверки версии программы с указанной на Github, и, в случае несовпадения, программа обновления скачивает файл и ожидает, когда исходная программа завершит свою работу. По завершению происходит замена файлов.| 
| ПЕРИОДИЧЕСКИЙ КОНТАКТ |	Периодическая отправка сообщения от клиента «Все в порядке». Если не идут сообщения, то через некоторое время завершить принудительно клиент и изменить статус аккаунта| 
| УВЕДОМЛЕНИЕ | При достижении лимита на каком-либо объекте, программа должна уведомить об этом ответственное лицо, указанное в файле настроек. Уведомление осуществляется с помощью почтовой рассылки.| 


Техническое задание было обговорено и утверждено в присутствии Никиты Хохлова, Станислава Жиленко и Максима Горбатюк. Предполагается, что внедрение новых функций в приложение не включается в изначальное техническое задание, и их реализация будет обсуждаться отдельно. По договору о продаже программного обеспечения разработчик обязан сопровождать систему в течение 3 месяцев. В этот срок должны выявиться все ошибки и исключения, которые не были выявлены на стадии альфа- и бета-тестировании. Такие ошибки и исключения исправляются в обязательном порядке.
 
# Элементы системы
Система распределения состоит из нескольких элементов, и в данной главе будет описана подробная информация о них и их настройке. В подглавах описаны файлы настроек для соответствующих приложений в формате *.xml. Настраивать программу необходимо через изменение значений внутри соответствующих тегов. Единую системы составляют три элемента: _БАЗА – СЕРВЕР – КЛИЕНТ_. Для всех программ главным условием работы является наличие установленного на компьютере .NET Framework версии не ниже 4.5.2. И стабильная связь, естественно.

## БАЗА
БАЗА – база данных PostgreSQL, располагающаяся на удаленном сервере. База данных доступна для подключения по IP-адресу и стандартному порту для PostgreSQL – 5432. В случае, если порт подключения иной, программа настраивается соответственно. Для настройки БАЗЫ необходимо развернуть базу данных PostgreSQL на серверной машине, на которой установлена ОС Linux Debian либо другая сборка. Для установки PostgreSQL использовалась команда 
```
sudo apt-get install postgresql.
```
Настройка подключения базы данных минимальна: необходимо отредактировать строки в файле /etc/postgresql/<версия>/main/postgresql.conf таким образом: 
* В строке listen_addresses = ‘localhost’ заменить значение на ‘0.0.0.0’. Таким образом, база данных доступна для подключения извне, а не только для локального подключения. 
* В строке port = ‘5432’ можно заменить указанный порт на другой. Для разрешения подключения необходимо отредактировать файл /etc/postgresql/<версия>/main/pg_hba.conf следующим образом: нужно добавить в конец файла строку host all all 0.0.0.0/0 md5. Это разрешит для любых пользователей любые действия и подключения с любого ip. Считается, что на данный момент база данных доступна для подключения извне. 

Для создания базы данных и таблиц необходимо подключиться к ней локально через ssh соединение. Создается отдельная база данных, а в ней – три таблицы:
* Таблица аккаунтов “steamusers”, в которой будут содержаться записи аккаунтов. Столбцы таблицы: id:int, user_name:string (логин аккаунта), user_password:string (пароль от аккаунта), available:int (статус аккаунта. 1 – свободен, 0 - занят), club (название клуба), computer (название компьютера). Последние две графы могут быть пустыми – сюда записываются клуб и компьютер только в случае, если аккаунт сейчас занят. На данный момент id:int – индекс аккаунта – имеет неочевидную функциональность. В базе данных PostgreSQL нет встроенного счетчика записей, и поэтому идентификационный номер был реализован с помощью int-числовой последовательности. Отсюда и проблемы с порядком записей – отсутствие автоматической инкрементации в постгрес не позволяет провести упорядочивание записей. Id аккаунта используется для поиска аккаунта в базе данных, передаче его КЛИЕНТУ и тд.
* Таблица лимитов “limits”. Таблица состоит из полей: id:int, club_name (название клуба/объекта), limit_accounts (Число ограничения выдачи аккаунтов), description (описание записи). При запуске СЕРВЕР считывает свой лимит из данной таблицы, осуществляя поиск по своего названию, взятому из файла настроек.
*	Таблица статистики “statistic”. Таблица состоит из полей: id_user:int (id аккаунта), club_name:string (название клуба), computer:string (название компьютера), take:int (флаг записи: 1 при взятии), free:int (флаг освобождения), date:timestamp (Время записи). 

Названия таблиц не рекомендуется менять, так как программы системы обращаются именно к этим названиям таблиц. 

## СЕРВЕР
СЕРВЕР представляет собой программу, в главном окне которой располагается таблица аккаунтов и поле для отображения событий жизненного цикла. Берет настройки из файла settings.xml, который должен находиться в одной директории с ней. Файл настроек содержит данные для подключения к базе данных: ip-адрес, имя пользователя, пароль и название базы данных, содержащей ключевые три таблицы, а также название объекта, где она находится (название игрового центра).

При запуске программа берет данные о лимите аккаунтов. После запуска программа прослушивает порт 8081 в локальной вычислительной сети на предмет подключений КЛИЕНТОВ. В случае, если КЛИЕНТ подключился с запросом, СЕРВЕР определяет тип запроса и формирует ответ и отправляет его КЛИЕНТУ. Предполагается, что КЛИЕНТ сообщает СЕРВЕРУ каждую 1 минуту о статусе запрошенного аккаунта, подтверждая его использование. В случае, если за 2 минуты не было сообщений от КЛИЕНТА, то предполагается, что программа была завершена некорректно, и сейчас аккаунт не используется. Статус данного аккаунта меняется на противоположный. В случае, если сам СЕРВЕР по какой-либо причине был закрыт, то при запуске он отследит записи в таблице аккаунтов, где в графе club указано его название, и сформирует список использующихся аккаунтов. Работа системы будет восстановлена без последствий.

В версии СЕРВЕРА 2.0.0.0 beta файл настроек претерпел изменения, и теперь он один для всех модулей программы. В случае отсутствия файла или проблем с его содержимым рекомендуется в первую очередь настроить его через программу СЕРВЕР. 

Для функционирования программы необходимы файлы, список которых изображен на рисунке слева. При отсутствии какого-либо файла работа программы не гарантируется. Файл settings.xml – конфигурационный файл программы. Файлы *.dll – библиотеки, использующиеся для подключения к БАЗЕ и расшифровки сообщений от КЛИЕНТОВ. Файл MailSender.exe – программа отправки почты. Когда лимит аккаунтов достигнут, то СЕРВЕР должен уведомить об этом. СЕРВЕР запускает программу отправки почты и передает ей параметры: указанный лимит и название объекта. Программа MailSender.exe берет из файла настроек массив с перечисленными адресами-получателями и осуществляет рассылку.
Файл настроек settings.js представляет собой текстовое отображение класса настроек. Его листинг в версии 4.0.0.0: 
```
{
  "DatabaseName":"SteamAccounts.db3",
  "PostgresConnectionString":"Host=Off.ala.next.kz;Port=5432;User ID=postgres;Password=AsusNotebook;Database=postgres;",
  "CenterName":"test_club",
  "AskAccounts":false,
  "AddressesList":["192.168.1.0"],
  "GiveAccounts":false,
  "SetIssueLimit":false,
  "IssueLimitValue":1,
  "DefaultSettings":false,
  "UsedMinuteLimit":5,
  "CloseOnException":false
}
```

## Описание файла настроек:
* Postgres_database – название базы данных. 
* Postgres_data_source – ip-адрес подключения. 
* Postgres_user – имя пользователя для подключения к БАЗЕ. 
* Postgres_password – пароль. clubName – название клуба. Порт для постгреса используется стандартный – 5432. Поэтому он не прописывается в настройках.
* Mysql_database – название базы данных. Mysql _data_source – ip-адрес подключения. Mysql _user – имя пользователя для подключения к БАЗЕ. Mysql _password – пароль. Порт используется стандартный – 3306. Поэтому он не прописывается в настройках. Изменять настройки можно методом изменений значений соответствующих тегов.
* Email_user – имя почтового аккаунта, а email_password – его пароль соответственно. Программа отправляет письма от имени указанного почтового аккаунта. 
* Email_domain – название почтового smtp сервера, а Email_domain_port – его порт. Эти настройки берутся из документации конкретного почтового сервера. 
* Email_to_send – массив с перечисленными получателями рассылки. Можно добавлять теги \*<string>….</string>\*, чтобы увеличить или уменьшить количество получателей рассылки. 

СЕРВЕР располагает окном настроек, где можно изменять настройки, не открывая settings.xml. 

## КЛИЕНТ
Клиентское приложение запускается на игровом компьютере и отправляет запрос на аккаунт и, в случае положительного ответа СЕРВЕРА, запускает выбранную игру. Запуск программы осуществляется через ярлык, с помощью которого передаются два параметра: код игры Steam и Название программы для отображения его в заголовке окна. КЛИЕНТ и СЕРВЕР общаются между собой с помощью зашифрованных сообщений в формате JSON, для шифровки и дешифровки используются соответствующие библиотеки в директории программ. Повторный запуск КЛИЕНТА невозможен. В зависимости от состояния и ответной реакции СЕРВЕРА КЛИЕНТ отображает соответствующее текстовое сообщение пользователю. Текст сообщений можно настроить в файле настроек settings.js:
```
{
  "OkayMessage":"Данные аккаунта приняты. Запускаю Steam",
  "CancelMessage":"К сожалению, Вы не можете сейчас воспользоваться аккаунтом",
  "BadConnectionMessage":"Соединение с сервером отсутствует. Обратитесь к оператору",
  "NoAvailableAccountsMessage":"Отсутствуют свободные аккаунты. Обратитесь к оператору",
  "LimitMessage":"Достигнут предел выделенных аккаунтов. Обратитесь к оператору",
  "ReleasedMessage":"Аккунт освобожден",
  "IpAddress":"127.0.0.1",
  "ProcessName":"steam",
  "SteamDirectory":"C:\\Program Files (x86)\\Steam\\steam.exe"
}
```
Список параметров:
* OkayMessage – сообщение, когда все идет своим чередом
* CancelMessage – сообщение, когда пришел отказ от СЕРВЕРА
* HasNoFreeAccount – отображается, когда от СЕРВЕРА пришел ответ об отсутствии свободных аккаунтов
* BadConnection – сообщение при отсутствии связи с СЕРВЕРОМ
* LimitMessage – сообщение, когда СЕРВЕР исчерпал свой лимит аккаунтов.
* freeAccount – сообщение перед завершением программы, когда аккаунт освобожден.
* Ip_adress – адрес СЕРВЕРА в локальной вычислительной сети
* Port – порт подключения к серверу. Не рекомендуется изменять его
* Process_name – название отслеживаемого процесса. Не рекомендуется изменять его
* steamDirectory – директория Steamа. Необходимо указать полностью путь до файла Steam.exe

Программа при запуске Steam отслеживает его активность и, в случае завершения работы Steam, посылает уведомление СЕРВЕРУ о том, что аккаунт не используется. Также 1 раз в минуту КЛИЕНТ отправляет сообщение СЕРВЕРУ о том, что клиент еще используется. Это реализовано для того, чтобы в случае краша КЛИЕНТА используемый им аккаунт принудительно был освобожден СЕРВЕРОМ. Предполагается, что при запуске программ/игр nonSteam сработает сторонний скрипт, завершающий работу Steam, и, следовательно, завершающий КЛИЕНТ. В случае, если КЛИЕНТ потерял связь с СЕРВЕРОМ, то это никак не влияет на его работу.

## ИНТЕРФЕЙС
(__Updated: Сейчас не поддерживается__)
Интерфейс базы данных – расширенный СЕРВЕР с вырезанными функциями обмена сообщений. Поэтому файл настроек settings.xml для него идентичный и список необходимых файлов и библиотек тоже. ИНТЕРФЕЙС предоставляет возможность для администрирования БАЗЫ, редактируя таблицы базы данных. Ниже представлен скриншот программы:
 
В левой части отображается таблица статистики и управляющие элементы. С помощью выпадающих списков можно задать условия выборки из базы данных и получить результирующую таблицу. Например, вывод всех записей за последний час данного клуба. В центральной части отображен поле для вывода лога событий. В левой части находится таблица аккаунтов и управляющие элементы для поиска конкретного аккаунта. 
В меню программы есть возможность обратиться к окну настроек, включить функцию автообновления данных, а также открыть окна редактирования таблиц БАЗЫ. Автообновление осуществляется с помощью периодического запроса к БАЗЕ на вывод всей информации. При обновлении информации меняется информация в таблицах, поэтому выделения конкретной строки сбрасываются. Стоит выключить функцию автообновления при работе с выводом статистики.
 
## Алгоритм работы системы
Работа системы начинается, когда пользователь запускает ярлык на игровом компьютере. Запускается КЛИЕНТ с переданными через ярлык параметрами: код игры и название. КЛИЕНТ отправляет запрос СЕРВЕРУ. СЕРВЕР принимает запрос и сканирует таблицу на наличие свободных аккаунтов. 

Успех. В случае, если свободные аккаунты имеются, и лимит данного клуба не достигнут, СЕРВЕР берет первый свободный аккаунт по списку, изменяет его статус, заносит в таблицу статистики соответствующую запись и посылает ответ КЛИЕНТУ. КЛИЕНТ получает успешный ответ и запускает Steam, передавая в качестве параметров логин, пароль аккаунта и код игры. Также в окне КЛИЕНТА отображается соответствующее сообщение.

Достигнут лимит или отсутствуют свободные аккаунты. В случае достижения лимита, СЕРВЕР отправит ответный запрос с соответствующим ключевым словом, и КЛИЕНТ отобразит сообщение на главном окне пользователю.

В процессе жизненного цикла КЛИЕНТ сканирует список всех процессов на наличие steam.exe. Его наличие символизирует использование переданного аккаунта, а отсутствие – завершение сессии. Отсутствие процесса знаменует начало завершающего алгоритма КЛИЕНТА. КЛИЕНТ отправляет сообщение СЕРВЕРУ о том, что данный аккаунт не используется. СЕРВЕР изменяет статус аккаунта на «свободный», занося в таблицу статистики запись об этом. КЛИЕНТ спустя несколько секунд закрывается, предоставляя возможность повторного вызова игры Steam.
Периодически КЛИЕНТ посылает сообщение СЕРВЕРУ о том, что данный аккаунт еще используется. СЕРВЕР при передаче аккаунта по запросу формирует массив аккаунтов и редактирует его при каждом изменении статуса аккаунтов на своем объекте. В случае, если КЛИЕНТ не прислал сообщение такого рода в течение двух минут, СЕРВЕР считает, что КЛИЕНТ был завершен неправильно, и принудительно меняет статус аккаунта, занося соответствующую запись в таблицу статистики с пометкой «Принудительно».
