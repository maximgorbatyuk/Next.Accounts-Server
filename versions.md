# Версии
Здесь описываются версии и суть изменений, которые были внедрены, начиная с самого начала разработки приложения. Иногда версии пропускались, потому что... потому что. Кто его знает... Энивей, для истории становления азработчика как программиста почитать полезно. Далее копирую незимененный текст версий (на момент 17/04/2016), за исключением разметки, разве что.

## Версии системы
В этой главе будут описаны все версии программы, выявленные баги, исключения и ошибки, а также произведенные действия по их исправлению.

## Версия 1.0.0.0
Первоначальная версия программы, выпущенная в бета-тестирование в начале сентября в центре «Esentai». СЕРВЕР, КЛИЕНТ, ИНТЕРФЕЙС имеют версию 1.0.0.0. БАЗА представлена базой данных MySQL, расположенной локально на том же компьютере, что и СЕРВЕР. Количество КЛИЕНТОВ было ограниченно десятью. Тестирование длилось около недели, и явных ошибок разработки выявлено не было. Однако пока система не отвечала поставленной задаче – БАЗА должна быть единой для всех центров, а значит – удаленной. 

## Версия 1.1.0.0
Изменение: СЕРВЕР, ИНТЕРФЕЙС. Настройка системы на работу с удаленной базой данных PostgreSQL. Причины: постгрес хорошо ладит с Linux, который установлен на удаленном сервере, а также невозможность настройки MySQL на соединение извне. Был переписан модуль подключения к БАЗЕ, использовались специальные библиотеки подключения к постгресу. На этапе альфа-теста отладка системы происходила с участием БАЗЫ, развернутой в Digital Ocean, и этот ресурс заблокировал выделенный сервер из-за частых подключений извне. Отладка программы была приостановлена до тех пор, пока БАЗА не была перенесена на виртуальную машину в офисе Next.KZ. Изменения коснулись только СЕРВЕРА и ИНТЕРФЕЙСА, КЛИЕНТ не нуждается пока в исправлениях.

## Версия 1.2.0.0
Изменение: СЕРВЕР. Выявлен был баг отправки писем с уведомлением о том, что достигнут лимит аккаунтов в некотором центре 14 октября 2015. Баг был вызван из-за того, что программа пыталась отправить письма от имени почтового аккаунта домена @next.kz (gmail.com). А так как при достижении лимита сначала вызывалась функция отправки письма, а только затем формирование ответного запроса к КЛИЕНТУ, то СЕРВЕР зависал, останавливая работу системы. Баг остановки системы был решен перекладываний функций отправки писем на отдельное приложение-модуль в составе СЕРВЕРА. Отладка программы на предмет отправки писем выполнялось при использовании smtp.yandex.ru и почтового аккаунта разработчика в этом домене. Работа с другими доменами не тестировалась. Проблема отправки писем не была еще решена, но работоспособность системы была восстановлена. Одним из предложенных вариантов решения является создание отдельного почтового аккаунта для отправки писем с уведомлением.

## Версия 1.2.1.0
Исправлены: СЕРВЕР, КЛИЕНТ. Изменения в СЕРВЕРЕ коснулись парсинга строк в модуле подключения к БАЗЕ. Проблема обнаружилась в Есентае, лог ошибки показал, что не закрыто подключение к БАЗЕ. Такая ошибка возникает, когда транзакция к базе данных открывается, но не закрывается. Проблему решил тем, что добавил закрытие подключения к БАЗЕ при каждой процедуре. Возникла другая ошибка – при принятии сообщения от КЛИЕНТА о том, что данный аккаунт еще используется, функция проверки id аккаунта вызывала исключение парсинга. Ошибка была отслежена и исправлена. Изменений в КЛИЕНТЕ немного – всего одно: программа теперь сворачивается после запуска стима, чтобы не мешать пользователю.

## Версия 2.0.0.0 beta
Исправлены: СЕРВЕР. Изменения СЕРВЕРА коснулись интерфейса программы, а также добавлены некоторые новые возможности.  
Главным нововведением стала потенциальная возможность программы работать в оффлайн режиме – когда БАЗА недоступна. Для этого на компьютере необходим установленный сервер базы данных MySQL с созданной базой данных и таблицами. Автоматически программа пока не создает таблицы. Если БАЗА не отвечает на запрос, то программа автоматически переключается на использование локальной БАЗЫ. Пока не определены многие алгоритмы работы системы в онлайн-оффлайн, например, если аккаунт был взят во время онлайн-режима, но его возврат осуществляется после перевода в оффлайн. Причина – необходимо встретиться ключевому персоналу и определить эти алгоритмы. Была выдвинута идея о сети peer2peer, чтобы СЕРВЕРЫ хранили определенный запас аккаунтов в локальной БАЗЕ, а при нехватке «просили» у остальных СЕРВЕРОВ. Идея требует быть обговоренной и обдуманной. После реализации базовой функции режима работы оффлайн в почтовой переписке было решено отказаться от оффлайн режима как такового: БАЗА должна быть развернута там, где на нее влияние внешних факторов сократится к минимуму. То есть, система не сможет исполняться свои функции только тогда, коогда в центрах бует отсутствовать подключение к Интернет. Собственно, когда нет Интернета, тогда и нет возможности играть в игры Steam. Поэтому дальнейшая реализация оффлайн-режима была «заморожена» до дальнейших указаний.

Добавлена возможность просматривать статистику своего центра в соответствующем окне за все время и за определенные интервалы. Центр определяется настройками программы. 
Реализована функция перезагрузки настроек без закрытия приложения – по событию кнопки «Загрузить настройки» программа перезаписывает в память настройки из файла и перезагружает подключение.

Окно настроек претерпело изменения. Теперь настройки полностью отображаются в окне. Можно настроить теперь и модуль Mail Sender, так как он теперь подхватывает настройки из файла settings.xml. Можно настроить почтовый аккаунт, а также ввести в текстовое поле построчно аккаунты-получателей уведомлений. Изменена иконка приложения Mail Sender. 
Изменен файл настроек settings.xml. Теперь он един для всех модулей программы. Хранит настройки подключения к БАЗЕ и к локальной БАЗЕ, почтовые настройки и тд.
Добавлена функция ввода пользовательского SQL запроса. Вводить необходимо только запросы, которые не возвращают результата, например, Insert, Update, Delete. Тест проходил командой Insert, другие команды пока не тестировались. Не рекомендуется вводить запросы без необходимости, так как нет пока никаких механизмов защиты. UPD: Пока что ввод запросов отключен для безопасности.

## Версия 2.0.0.1 beta. 
Изменены: СЕРВЕР. Была решена частично часто возникающая проблема освобождения аккаунта из внутреннего массива использованных аккаунтов. Предполагаемая причина ошибки: когда аккаунт освобождается принудительно в следствие отсутствия уведомлений об использовании, то СЕРВЕР его освобождал в БАЗЕ и удалял из внутреннего массива использующихся аккаунтов, но когда от КЛИЕНТА приходило сообщение об освобождении этого же аккаунта, то программа вновь пыталась найти аккаунт в массиве и удалить его. Тут возникало исключение. Еще одной предполагаемой причиной является ошибка использования названия центра на другом объекте – СЕРВЕР берет из БАЗЫ при включении все аккаунты, которые ему принадлежат, и добавляет в свой внутренний массив. Очевидно, что сообщения об использовании этих аккаунтов на данный СЕРВЕР не придут, и СЕРВЕР освобождает их принудительно. Сейчас внедрена была функция оповещения о том, что данный центр уже используется на другом объекте. СЕРВЕР при запуске меняет статус в таблице БАЗЫ limits на противоположный. При завершении работы происходит то же самое. Если центр используется уже, то программа выдаст сообщение в логи.

## Версия 2.0.0.3 beta
Изменены: СЕРВЕР. Была добавлена функция вывода кодов ошибок вместо окон исключения, которые мешали нормальной работе программы. Коды ошибок приведены в этом документе в соответствующей главе. Ошибки теперь записываются в отдельный файл «errors.txt» с указанием времени, чтобы было легче отслеживать проблемы программы при возникших исключениях. Изменена немного структура классов таким образом, чтобы при возникших исключениях вывод информации шел как сообщение между классами, а не диалоговое окно. 

## Версия 2.0.1.0 beta
Изменены: СЕРВЕР. Была проведена большая работа над оптимизацией работы программы при обработке запросов от КЛИЕНТОВ. Ответная реакция на запросы была перенесена из класса Form1 в класс ServerSocket. Добавлены описания ошибок в список. Исправлены ошибочные выводы полученных сообщений по сети в файл вывода ошибок. 

## Версия 2.0.1.0 beta
Изменены: КЛИЕНТ. Версия клиента изменилась до 1.0.1.0. Добавлена функция вывода сообщений ошибок в отдельный файл errors.txt. Если файл отсутствует, то программа создаст его автоматически. Изменен графический интерфейс, добавлен логотип Next.kz. Изменен модуль ассистента КЛИЕНТА – изменено название, теперь он отображается в трее. КЛИЕНТ при закрытии пользователем сворачивается и выводит окно «Не рекомендуется закрывать это окно…». Функция запуска апдейтера деактивирована, так как помимо самого файла программы КЛИЕНТУ помогают другие утилиты, скачивание которых пока не реализовано.

## Версия 2.3.0.0 beta
Изменены: СЕРВЕР, КЛИЕНТ, ИНТЕРФЕЙС. Клиент обновлен до версии 1.2.0.0. Добавлены были следующие фичи: 
*	Вывод своей версии в отдельный файл в директории папки для того, чтобы была возможность прочесть версию программы и заменить удаленно.
*	При повторном запуске клиента (Стим уже запущен) вместо вывода сообщения об ошибке будет разворачиваться и выводиться на экран окно стима. Таким образом, у пользователя создается иллюзия верной реакции на его действия: он запустил игру через ярлык – он получил главное окно стима с библиотекой игр.
*	При завершении программы через внутренний вызов либо по выключению ОС клиент отсылает сообщение об освобождении аккаунта.

Сервер был изменен чуть менее чем полностью. Его работа перестроена таким образом, чтобы он минимально зависел от удаленной базы данных. Для этого необходима развернутая база данных MySQL на локальной машине и созданная в ней база данных. Создание таблиц при этом не требуется, так как программа создаст необходимые ей таблица самостоятельно. Локальная таблица аккаунтов заполняется автоматически на основании указанного лимита аккаунтов в удаленной базе данных. При поступлении запроса на аккаунт сервер выдаст теперь первый свободный аккаунт из локальной базы данных. При освобождении аккаунта программа сделает запись и в свою локальную статистику, и в удаленную базу данных, если существует соединение с ней. В случае, если в течение работы программы лимит был изменен в удаленной базе данных, то программа каждую минуту проверяет лимит в базе и меняет в случае несоответствия установленного ранее с новым. При возникающих проблемах с базой или соединением в центре сервер переключится в оффлайн-режим. В процессе работы сервер раз в 4 минуты проверяет соединение с удаленной базой, так что при устранении неполадок сервер автоматически переключится в онлайн-режим. Режим онлайн и оффлайн отличаются друг от друга тем, что в онлайне доступны проверка лимита с определенной периодичностью, запись статистики в удаленной базу, а также просмотр статистики и таблицы аккаунтов из удаленной базы данных. Основной функционал программы не зависит от подключения к интернету либо к удаленной базе данных. Был переработан алгоритм отправки служебных сообщений: теперь программа собирает уведомления в пул и отсылает сообщение только если в пуле либо одно, либо 10 уведомлений. При отправке пул освобождается. 

Время простоя аккаунта, по истечению которого он будет освобожден, теперь можно вводить через файл настроек. Раньше это время было введено в коде и было равно 2 минутам. Сейчас рекомендуется оставить время равное двадцати минутам. В одном из центров для эксперимента была протестирована программа, которая освобождала аккаунты по истечению тридцати минут, и это дало уменьшение доли освобождения аккаунта до < 10%. Причина освобождения аккаунтов принудительно при том, что они были еще использованы на одном из ПК, была в том, что сервер их освобождал из-за отсутствия сообщений от клиента либо от внутренней ошибки обработки массива использующихся аккаунтов, так как обработчик запросов и массив аккаунтов были объявлены в разных потоках. Сейчас модуль серверного обработчика событий управляет массивом аккаунтов, а модуль главного окна дает лишь указания п событию таймеров.
Был введен веб-сервер в программу сервер для будущих апдейтов. Было решено организовать общение серверов в будущем именно через веб-запросы, на которые программа будет отвечать той или иной служебной информацией. Основная цель введения – избавиться от удаленной базы данных, а в случае достижения лимита в одном из центров этот центр отправит веб-запрос другим центрам на аккаунт. Таким образом, центр, где в данный момент нагрузка минимальна, будет предоставлять свои аккаунты центру, где нагрузка приближается к максимальной. На данный момент реализована лишь стартовая страница с выводом общей информации о сервере и серверной машине. 
ИНТЕРФЕЙС был изменён незначительно – была добавлена функция вывода времени сессий в определённых центрах.

## Версия 3.0.0.0. 
Изменены: СЕРВЕР, ИНТЕРФЕЙС. СЕРВЕР теперь может общаться с другими серверами при условии, что адреса этих серверов прописаны в настройках программы. Файл настроек был дополнен так же переключателями выдачи/запроса аккаунтов у других серверов при малом количестве свободных собственных. Алгоритм запроса аккаунтов: при запросе клиента на аккаунт и при условии, что свободных больше нет, СЕРВЕР пройдется по списку адресов в настройках и от каждого запросит аккаунты. Если к СЕРВЕРУ был прислан запрос на аккаунты, данный сервер при условии наличия свободных аккаунтов высчитывает примерно 20% свободных аккаунтов и посылает списком запросившему. Если от первого же сервера пришли аккаунты, цикл прерывается. Если аккаунты не пришли, то происходит следующая итерация цикла – запрос отправляется по следующему адресу. В настройках можно указать разрешение на выдачу и запрос аккаунтов. Если эти действия запрещены, то сервер не запрашивает аккаунты и посылает ответ веб-запросам «нет свободных аккаунтов». Лимит аккаунтов теперь не считывается из удаленной базы данных, а основывается на количестве записей в локальной базе данных. При передаче аккаунтов в другой центр эти аккаунты удаляются. Будет выслан отказ в случае, если число записей в таблице аккаунтов меньше 1.

Была добавлена функция бэкапа/восстановления списка аккаунтов в данном центре. Аккаунты записываются в файл в корне программы при запуске, если этот файл отсутствует. В окне настроек можно явно произвести бэкап и восстановление в базу. Были убраны процедуры копирования аккаунтов из удаленной базы при условии несовпадения числа записей в таблице и установленного лимита. Добавлены процедуры создания таблиц и записей аккаунтов в нее при условии отсутствия таблицы в локальной базе данных. 
Был создан специальный аккаунт для служебных целей системы Game Control. Были убраны некоторые записи, выводящиеся в логи программы для сокращения потока, добавлен идентификатор подключения к локальной базе данных на главном окне программы.

ИНТЕРФЕЙС. Были убраны ненужные функции на данный момент, касающиеся удаленной базы данных, настроек программы. Добавлена функция управления веб-запросами СЕРВЕРАМ системы. По запросу может быть прислана информация о сервере, статистика за определённый интервал (день, месяц, все время). 

## Версия 3.0.1.0 (17/04/2016)
В версии разработчик решил заняться рефакторингом проекта. Изменены некоторые функции считывания информации из классов в форм-класс. Внедрены делегаты и EventHndler'ы. ПО крайней мере внедряются. Вводится разделегирование функций, выполняемых классами. Например, класс [SocketServer.cs](https://github.com/maximgorbatyuk/Next_local_server_2/blob/Version-4-start/mysqlApplication/Communication/SocketServer.cs) сильно перегружен, было решено его разгрузить, но как - пока не известно. Разработчик занимается этим вопросом. В планах много еще чего, но обо всем по порядку. Проект был начат в отдельной ветке Version-4-start. Пока в ней и будут сохраняться нововведения.
